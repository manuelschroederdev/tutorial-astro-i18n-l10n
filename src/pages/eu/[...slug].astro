---
import { useStoryblokApi } from '@storyblok/astro';
import StoryblokComponent from '@storyblok/astro/StoryblokComponent.astro';
import Layout from '../../layouts/Layout.astro';
import { getLanguageCodes } from '../../utils/i18n';
import { getStoryblokPaths } from '../../utils/paths';

export async function getStaticPaths() {
	const languages = await getLanguageCodes();

	const staticPaths = await getStoryblokPaths('eu', languages);
	console.log('staticPaths EU', staticPaths);
	return staticPaths;
}

const slug = Astro.params.slug?.split('/') ?? [];

const languages = await getLanguageCodes();
const language = languages.includes(slug[0]) ? slug[0] : undefined;

if (language) {
	slug.shift();
}

const storyblokApi = useStoryblokApi();
const { data } = await storyblokApi.get(
	`cdn/stories/eu/${slug && slug.length > 0 ? slug.join('/') : 'home'}`,
	{
		version: 'draft',
		resolve_links: 'story',
		language,
	},
);

const story = data.story;
---

<Layout currentLanguage={language} story={story}>
	<StoryblokComponent currentLanguage={language} blok={story.content} />
</Layout>
